#!/usr/bin/env bash

# Colors and styling
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Nerd Font icons
ICON_MIC="󰍬"
ICON_WAVE="󰝚"
ICON_CHECK="󰄬"
ICON_ERROR="󰅚"
ICON_LOADING="󰔟"
ICON_SERVER="󰒋"
ICON_SOUND="󰓃"
ICON_VIDEO="󰕧"
ICON_YOUTUBE="󰗃"
ICON_CONVERT="󰁕"
ICON_INFO="󰋼"

# Debug mode
DEBUG=false

# Function to log debug information
debug_log() {
    if [ "$DEBUG" = true ]; then
        echo -e "${CYAN}[DEBUG] $1${NC}" >&2
    fi
}

# Function to check if service is running
check_service() {
    debug_log "Checking service health..."
    local health_response
    health_response=$(curl -s "http://localhost:8000/health")
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}${ICON_ERROR} Error: Whisper service is not running${NC}"
        echo -e "${BLUE}${ICON_SERVER} Start the service with:${NC} docker compose up -d"
        return 1
    fi
    
    debug_log "Service is healthy"
    return 0
}

# Function to check if file is supported audio format
check_audio_format() {
    local file="$1"
    local ext="${file##*.}"
    ext="${ext,,}"  # Convert to lowercase
    
    local valid_extensions=("mp3" "wav" "m4a" "ogg" "flac")
    if [[ " ${valid_extensions[*]} " =~ " ${ext} " ]]; then
        debug_log "File format '$ext' is supported"
        return 0
    else
        echo -e "${RED}${ICON_ERROR} Error: Unsupported audio format '$ext'${NC}"
        echo -e "Supported formats: ${valid_extensions[*]}"
        return 1
    fi
}

# Function to show spinner while waiting
spinner() {
    local pid=$1
    local delay=0.1
    local spinstr='⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏'
    while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
        local temp=${spinstr#?}
        printf " %s %s" "${spinstr}" "${YELLOW}Processing...${NC}"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\r"
    done
    printf "\r"
}

# Function to send file to whisper service
send_to_whisper() {
    local file="$1"
    debug_log "Sending file to whisper service: $file"

    # Send request with curl
    echo -e "${YELLOW}${ICON_LOADING} Sending file to Whisper service...${NC}"
    
    # Use a temporary file for the response
    local temp_response
    temp_response=$(mktemp)
    
    # Send the request and capture the response
    curl -s -X POST \
         -F "file=@$file" \
         --max-time 3600 \
         "http://localhost:8000/transcribe/" > "$temp_response" &
    
    local curl_pid=$!
    spinner $curl_pid
    wait $curl_pid
    local curl_status=$?
    
    if [ $curl_status -ne 0 ]; then
        echo -e "${RED}${ICON_ERROR} Error: Failed to connect to service${NC}"
        rm -f "$temp_response"
        return 1
    fi
    
    # Read and validate the response
    local response
    response=$(cat "$temp_response")
    rm -f "$temp_response"
    
    debug_log "Raw response: $response"
    
    # Check if response is empty
    if [ -z "$response" ]; then
        echo -e "${RED}${ICON_ERROR} Error: Empty response from service${NC}"
        return 1
    fi
    
    # Try to parse as JSON and extract text
    if ! echo "$response" | jq . >/dev/null 2>&1; then
        echo -e "${RED}${ICON_ERROR} Error: Invalid JSON response${NC}"
        debug_log "Response was: $response"
        return 1
    fi
    
    # Output the full response
    echo "$response"
    return 0
}

# Function to show usage
show_usage() {
    echo -e "${BOLD}Usage:${NC}"
    echo -e "  whisper [options] <file>"
    echo
    echo -e "${BOLD}Options:${NC}"
    echo -e "  -h, --help     Show this help message"
    echo -e "  -v, --verbose  Show detailed output including segments"
    echo -e "  --debug        Enable debug logging"
    echo
    echo -e "${BOLD}Examples:${NC}"
    echo -e "  whisper audio.mp3"
    echo -e "  whisper --verbose recording.wav"
    echo -e "  whisper --debug audio.mp3"
}

# Parse command line arguments
VERBOSE=false
FILE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_usage
            exit 0
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        --debug)
            DEBUG=true
            shift
            ;;
        *)
            if [[ -f "$1" ]]; then
                FILE="$1"
            else
                echo -e "${RED}${ICON_ERROR} Error: File '$1' not found${NC}"
                exit 1
            fi
            shift
            ;;
    esac
done

# Check if a file was provided
if [ -z "$FILE" ]; then
    show_usage
    exit 1
fi

# Main execution
echo -e "\n${BLUE}${ICON_SOUND} Whisper Transcription${NC}"

# Check if file exists and is readable
if [ ! -r "$FILE" ]; then
    echo -e "${RED}${ICON_ERROR} Error: Cannot read file: $FILE${NC}"
    exit 1
fi

# Check service health
check_service || exit 1

# Display file info
echo -e "${BLUE}${ICON_WAVE} Audio file:${NC} ${FILE}"

# Check audio format
check_audio_format "$FILE" || exit 1

# Send to whisper and capture response
response=$(send_to_whisper "$FILE")
exit_code=$?

if [ $exit_code -eq 0 ]; then
    echo -e "${GREEN}${ICON_CHECK} Transcription complete!${NC}\n"
    
    # Extract and display the text
    text=$(echo "$response" | jq -r '.text // empty')
    if [ -n "$text" ]; then
        echo -e "${BOLD}Transcription:${NC}"
        echo -e "$text\n"
        
        if [ "$VERBOSE" = true ]; then
            echo -e "${BOLD}Segments:${NC}"
            echo "$response" | jq -r '.segments[] | "\(.start)s -> \(.end)s: \(.text)"' 2>/dev/null
            echo
        fi
    else
        echo -e "${RED}${ICON_ERROR} Error: No transcription text in response${NC}"
        debug_log "Response was: $response"
        exit 1
    fi
else
    echo -e "${RED}${ICON_ERROR} Failed to get transcription${NC}"
    exit 1
fi

exit 0