# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

Whisper Transcription Service - A Docker-powered audio/video transcription service using OpenAI's Whisper model with two operational modes:
- **Local Compute Mode**: Runs Whisper model locally with GPU acceleration
- **API Mode**: Uses OpenAI's Whisper API

## Commands

### Build and Deploy
```bash
# Initial setup
chmod +x configure.sh build
./configure.sh              # Interactive mode selection (local/API)

# Build options
./build                     # Standard build
./build --clean             # Clean build (removes .env)
./build --cleandocker       # Remove old Docker images
./build --deploy            # Build and deploy
./build --clean --deploy    # Clean build and deploy

# Deploy
docker compose up -d                              # Local mode
docker compose -f docker-compose.api.yml up -d    # API mode

# View logs
docker compose logs -f whisper-service
```

### Development
```bash
# Stop service
docker compose down

# Rebuild after code changes
docker compose build
docker compose up -d

# Access container shell
docker exec -it whisper-service /bin/bash
```

## Architecture

### Core Components
- **main.py**: FastAPI application handling HTTP endpoints and job management
- **process_audio.py**: Audio processing pipeline and transcription orchestration
- **audio_chunker.py**: Intelligent chunking for large audio files (60-second chunks with 5-second overlap)
- **process_whisper.py**: Transcript processing utilities

### Processing Pipeline
1. File upload → validation → format detection
2. Audio extraction (for video files) → format optimization (16kHz, mono, MP3)
3. Chunking for large files → transcription (local/API) → result aggregation
4. Cleanup of temporary files

### Key Features
- Concurrent job processing with ThreadPoolExecutor
- Real-time progress tracking for chunked files
- Memory-efficient transcript streaming
- Automatic audio format optimization
- Support for: .mp3, .wav, .m4a, .mp4, .ogg, .flac, .mkv

### API Endpoints
- `POST /transcribe/`: Submit transcription job
- `GET /status/{job_id}`: Check job status (with optional transcript)
- `GET /jobs`: List all jobs
- `DELETE /jobs/{job_id}`: Terminate a job
- `GET /transcript/{job_id}`: Stream transcript
- `GET /health`: Service health check

### Configuration
- Environment variables in `.env` (generated by configure.sh)
- GPU support configured through Docker Compose for local mode
- Non-root user execution for security